    <h1>ScavHunt Survey</h1>

% if ($send == 0) {

    <h2> This is a Very Important Poll (TM).</h2>
    <P> Seriously, folks, we need to have this information sorted out into a 
      database before the Hunt begins. I will hunt you down if you do not 
      write me back. And honest answers only, please.
    </P>

    <P>Thank you,</P>

    <p style="margin-left: 5em">
      Cate Tolzmann, Spring 2001<BR>
      scavcat@myrealbox.com</p>

    <p>Fill out the survey!  If you haven't done it before, this will
      create a user account for you.  You will be given a user name
      and password; use them to log in with the box in the side menu.
    </p>

    <p>Don't hit <b>Send Survey</b> until you are happy with your
      answers!  That's what the <b>Update Survey</b> button is for.
      Check the bottom of this page to see the survey results that
      will be sent in when you hit the <b>Send</b> button.
    </p>

    <p>...Michael Milligan, Tech Turnip</p>

    <form action="survey.mhtml" method="GET">

      <P>
	<B>Name:</B> 
	<input type="TEXT" name="name" size="50" value="<% $ARGS{name} |h %>">
      </P>

      <p><b>Email:</b>
	<input type="text" name="email" size="50" value="<% $ARGS{email} |h %>">
      </p>
      
      <P>
	<B>Major:</B> 
	<input type="text" name="major" size="25" value="<% $ARGS{major} |h %>">
      </P>
      
      <P>
	<B>Talents</B>
	<br> 
      	Please list your talents, no matter how bizarre. Can you play the
	kazoo? Stand on your head? Eat large amounts of bacon without
	getting sick? Sew?
	<br>
	<textarea name="talents" rows="5" cols="70"><% $ARGS{talents} %></textarea>
      </P> 

      <p><b>Connections</b>
	<br>
	Buddies with Boyer?  Friend of a faculty member?  Compadre to
	the cops?  Let us know, so we can exploit your connections and
	influence!
	<br>
	<textarea name="connections" rows="3" cols="70"><% $ARGS{connections} %></textarea>
      </p>

      <P><B>Nudity</B>
	<br>
	How naked are you willing to get? Down to your underwear? Totally 
	topless? Maybe bottomless but not topless?  How public are you willing for
	that nudity to be? 
	<br>
	<textarea name="nudity" rows="2" cols="70"><% $ARGS{nudity} %></textarea> 
      </p>

      <P><B>Home</B>
	<br>
	Where is home? Would your parents be willing to send your childhood toys in
	the mail? (or drive them here?)
	<br>
	<textarea name="home" rows="2" cols="70"><% $ARGS{home} %></textarea>
      </p>

      <P><B>Meal Points</B>
	<br>
	Are you willing to donate 3 meal points to the team so we can get some 
	snacklings and some food with which to bribe the judges? (Hint to 
	first-years: You are not going to manage to use all of your meal points, 
	particularly during Spring Quarter).
      </p>
      <p>If yes, please also enter your ISO number (the long number above the
	barcode on your UC ID)
	<br>
	<input type="TEXT" name="points" size="50" value="<% $ARGS{points} |h %>">
      </p>

      <p><B>Age:</B>
	<input type="TEXT" name="age" size="10" value="<% $ARGS{age} |h %>">
      </p>
      
      <P><B>Schedule</B>
	<br>
	If you have a general sense of your schedule during Scav Hunt, please 
	let us know. Are you totally booked on Thursday afternoon? Free early 
	Friday morning?
	<br>
	<textarea name="schedule" rows="5" cols="70"><% $ARGS{schedule} %></textarea>
      </p>

      <p><b>Beta Tester:</b>
	<select name="beta">
	  <option <% $no_selected %> value="no">No, thanks</option>
	  <option <% $yes_selected %> value="yes">Sure, why not</option>
	</select>
      </p>

      <input type="hidden" name="send" value="0">
      <input type="SUBMIT" value="Update Survey"> <input type="RESET" value="Reset">
    </form>

% }

% if ($send == 0) { 
    <h2>Prepared Emails</h2>
    <p>When you hit the "Send" button, the following emails will be sent (note that,
      until you hit that button, your survey <b>has not</b> been sent yet):</p>

    <form action="survey.mhtml" method="GET">
      <input type="hidden" name="msg" value="<% $message %>">
      <input type="hidden" name="beta_msg" value="<% $beta_message %>">
      <input type="hidden" name="name" value="<% $ARGS{name} |h %>">
      <input type="hidden" name="email" value="<% $ARGS{email} |h %>">
      <input type="hidden" name="major" value="<% $ARGS{major} |h %>">
      <input type="hidden" name="talents" value="<% $ARGS{talents} |h %>">
      <input type="hidden" name="connections" value="<% $ARGS{connections} |h %>">
      <input type="hidden" name="nudity" value="<% $ARGS{nudity} |h %>">
      <input type="hidden" name="home" value="<% $ARGS{home} |h %>">
      <input type="hidden" name="points" value="<% $ARGS{points} |h %>">
      <input type="hidden" name="age" value="<% $ARGS{age} |h %>">
      <input type="hidden" name="schedule" value="<% $ARGS{schedule} |h %>">
      <input type="hidden" name="beta" value="<% $ARGS{beta} %>">
      <input type="hidden" name="send" value="1">
      <input type="SUBMIT" value="Send Survey Emails">
    </form>

% } else {
    <h2>Sent Surveys</h2>
    <p>The following emails have been dispatched.  Your work here is done.
      See below for your username and password if you haven't previously
      created a user account here.</p>
% }

    <p><pre>
<% CGI::escapeHTML($headers . MIME::Base64::decode($send == 0 ? $message : $ARGS{msg})) %>
    </pre></p>

% if ( $ARGS{beta} eq "yes" ) { 
    <p><pre>
<% CGI::escapeHTML($beta_headers . MIME::Base64::decode($send == 0 ? $beta_message : $ARGS{beta_msg})) %>
    </pre></p>
% }
% if ( $created ) {
    <p>You have created a user account for <% $user->name %> in the
      Potato system:</p> 
    <ul>
      <li>Your login name is: <% $user->login %></li>
      <li>Your password is: <% $user->password %></li>
    </ul>
    <p>This information has been emailed to the address that you gave
      above.</p> 
% }

<%args>
$send => 0;
</%args>
      
<%init>

my $sendmail = $PageCapt::Web::sendmail;
my $to = "Cate Tolzmann <scavcat\@myrealbox.com>";
my $beta_to = "Michael Milligan <mbmillig\@uchicago.edu>";

if ( $User->isvalid ) {
  my %oldsurvey	     = PageCapt::DB::load_survey_user( $User );
  $ARGS{name}	     = $User->name unless $ARGS{name};
  $ARGS{email}	     = $User->email unless $ARGS{email};
  $ARGS{major}	     = $oldsurvey{major}{content} unless $ARGS{major};
  $ARGS{talents}     = $oldsurvey{talents}{content} unless $ARGS{talents};
  $ARGS{connections} = $oldsurvey{connections}{content} unless $ARGS{connections};
  $ARGS{nudity}	     = $oldsurvey{nudity}{content} unless $ARGS{nudity};
  $ARGS{home}	     = $oldsurvey{home}{content} unless $ARGS{home};
  $ARGS{points}	     = $oldsurvey{points}{content} unless $ARGS{points};
  $ARGS{age}	     = $oldsurvey{age}{content} unless $ARGS{age};
  $ARGS{schedule}    = $oldsurvey{schedule}{content} unless $ARGS{schedule};
  $ARGS{beta}	     = $oldsurvey{beta}{content} unless $ARGS{beta};
}

my $beta_headers = <<EOF;
To: $beta_to
Subject: FIST Beta test volunteer - $ARGS{name}
From: ScavHunt Survey <mbmillig\@midway.uchicago.edu>

EOF

my $beta_message = MIME::Base64::encode( <<EOF, "" );
The following user has volunteered for the beta test corps!
$ARGS{name}
$ARGS{email}

EOF

my $headers = <<EOF;
To: $to
CC: $beta_to
Subject: FIST Survey result for $ARGS{name}
From: ScavHunt Survey <mbmillig\@midway.uchicago.edu>

EOF

my $message = MIME::Base64::encode( <<EOF, "" );
Survey results for $ARGS{name}: 

 Email address: $ARGS{email}

 Talents: $ARGS{talents}

 Connections: $ARGS{connections}

 Major: $ARGS{major}
	    
 Nudity: $ARGS{nudity}

 Home: $ARGS{home}

 Meal points: $ARGS{points}

 Age: $ARGS{age}

 Schedule: $ARGS{schedule}

Thank you.
EOF

my $yes_selected = "selected" if $ARGS{beta} eq "yes";
my $no_selected = "selected" if $ARGS{beta} eq "no";

my $created = undef;
my $user = blank PageCapt::User;

if ($send != 0) {
  open(SENDMAIL, "|$sendmail") || die "Major problem: can't open sendmail!";
  print SENDMAIL $headers . MIME::Base64::decode($ARGS{msg});
  close SENDMAIL;

  if ( $ARGS{beta} eq "yes" ) {
      open(SENDMAIL, "|$sendmail") || die "Major problem: can't open sendmail!";
  print SENDMAIL $beta_headers . MIME::Base64::decode($ARGS{beta_msg});
  close SENDMAIL;
  }

  my ($login) = $ARGS{email} =~ /([^@]+)@/;
  $user = byname PageCapt::User ($login);
  $user->name($ARGS{name});
  $user->email($ARGS{email});
  $user->password( PageCapt::Web::generate_password($ARGS{name}) );
  $created = $user->create;

  my $surveystruct = {
    major        => $ARGS{major},
    talents	 => $ARGS{talents},
    connections	 => $ARGS{connections},
    nudity	 => $ARGS{nudity},
    home	 => $ARGS{home},
    points	 => $ARGS{points},
    age		 => $ARGS{age},
    schedule	 => $ARGS{schedule},
    beta	 => $ARGS{beta}
  };

  if ($created) {
    PageCapt::Web::mail_password( $user->uid );
    PageCapt::DB::new_survey( $user, $surveystruct ); }
  elsif ( $User->isvalid ) {
    PageCapt::DB::new_survey( $User, $surveystruct ); }
}

</%init>

<%method title>
<& PARENT:title &> - Team Survey
</%method>
<%method time_stamp>
<!-- hhmts start -->
Last modified: Sat May  3 13:51:53 CDT 2003
<!-- hhmts end -->
</%method>